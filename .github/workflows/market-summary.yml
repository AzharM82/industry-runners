name: Generate Daily Market Summary

on:
  schedule:
    # 10 PM UTC = 2 PM PST (Mon-Fri)
    # During PDT this runs at 3 PM PDT â€” still after market close (1 PM PDT)
    - cron: '0 22 * * 1-5'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Market Summary
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://agreeable-flower-06913690f.1.azurestaticapps.net/api/market-summary?key=${{ secrets.MARKET_SUMMARY_KEY }}")
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          echo "Response code: $http_code"
          echo "Response body: $body"
          if [ "$http_code" -ge 500 ]; then
            echo "Server error, retrying in 30 seconds..."
            sleep 30
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "https://agreeable-flower-06913690f.1.azurestaticapps.net/api/market-summary?key=${{ secrets.MARKET_SUMMARY_KEY }}")
            http_code=$(echo "$response" | tail -1)
            body=$(echo "$response" | sed '$d')
            echo "Retry response code: $http_code"
            echo "Retry response body: $body"
          fi
          if [ "$http_code" -ge 400 ]; then
            echo "::error::Failed with response code $http_code: $body"
            exit 1
          fi
